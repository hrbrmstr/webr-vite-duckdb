<!DOCTYPE html>
<!-- This file was auto-generated by exmd at 2023-04-06T21:49:12.742Z. Do NOT edit by hand! -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ üï∏Ô∏è WebR, Vite + ü¶Ü DuckDB via Observable's Standard Library</title><meta property="og:title" content="üß™ üï∏Ô∏è WebR, Vite + ü¶Ü DuckDB via Observable's Standard Library">
<meta property="twitter:title" content="üß™ üï∏Ô∏è WebR, Vite + ü¶Ü DuckDB via Observable's Standard Library">
<meta property="og:description" content="A Toy Modeling Example">
<meta property="twitter:description" content="A Toy Modeling Example">
<meta property="og:site" content="https://rud.is/w/webr-vite-duckdb">
<meta property="og:site_name" content="WebR Exeriments">
<meta property="og:image:url" content="https://rud.is/w/webr-vite-duckdb/preview.png">
<meta property="og:image:width" content="1932">
<meta property="og:image:height" content="1170">
<meta property="og:image:alt" content="example">
<meta property="twitter:site_name" content="@hrbrmstr">
<meta property="twitter:domain" content="rud.is">
<meta property="twitter:card" content="summary_large_image">
<meta property="article:published_time" content="2023-04-06T21:49:12.742Z">
<link rel='apple-touch-icon' sizes='180x180' href='./favicon/apple-touch-icon.png'/>
<link rel='icon' type='image/png' sizes='32x32' href='./favicon/favicon-32x32.png'/>
<link rel='icon' type='image/png' sizes='16x16' href='./favicon/favicon-16x16.png'/>
<link rel='manifest' href='./favicon/site.webmanifest'/>
<link href='./src/index.css' rel='stylesheet'/>
<link href='./src/components.css' rel='stylesheet'/>
<script type='module' src='./src/main.js'></script>
</head>
<body>
<h1>üß™ üï∏Ô∏è Vite + ü¶Ü DuckDB via Observable's Standard Library</h1>
<p><status-message id="webr-status" text="WebR Loading‚Ä¶"></status-message></p>
<h2>A Toy Modeling Example</h2>
<hr>
<p>&quot;Experiment&quot; Hypothesis:</p>
<blockquote>
<p><em>We can use DuckDB to wrangle data for us, let R do some &quot;modeling&quot;, and let Observable Plot show us the results</em></p>
</blockquote>
<p>&quot;Experiment&quot; parameters:</p>
<ul>
<li>Webr</li>
<li>Observable Standard Library's <code>DuckDBCLient</code></li>
<li>Observable Plot</li>
<li>Lit (web components)</li>
<li>Vite (for building)</li>
</ul>
<hr>
<h2>Adopt, Adapt, And Improve</h2>
<p>Building off of the previous experiment, today we will combine DuckDB data ops with WebR, letting R do some trivial modeling with <code>glm</code> on data we load and wrangle with DuckDB.</p>
<p>Let's be super clear, right up front: this data is small enough to load into R, process in R, and then model and plot in R without any other packages (save {svglite}). It is deliberately a toy example to make it easier to work with while showing the core concepts.</p>
<p>Here's the tables we have:</p>
<p><simple-message id="describe-tables"></simple-message></p>
<p>This is the schema for our <code>tags</code> table:</p>
<p><data-frame-view height="150" label="Tags Schema" id="tags-schema"></data-frame-view></p>
<p>This is what's in it:</p>
<p><data-frame-view label="Tags" id="tags-view"></data-frame-view></p>
<pre class="shiki " style="background-color: #0b0e14" tabindex="0"><code><span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- Setup a date range that spans the entire min/max created_at</span></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- We need this b/c we don&#39;t have tags every day so there are</span></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- gaps in the time series</span></span>
<span class="line"><span style="color: #FF8F40">WITH</span><span style="color: #BFBDB6"> date_range </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> (</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">SELECT</span><span style="color: #BFBDB6"> UNNEST(</span><span style="color: #F07178">generate_series</span><span style="color: #BFBDB6">(</span></span>
<span class="line"><span style="color: #BFBDB6">    (</span><span style="color: #FF8F40">SELECT</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">MIN</span><span style="color: #BFBDB6">(created_at) </span><span style="color: #FF8F40">FROM</span><span style="color: #BFBDB6"> tags),</span></span>
<span class="line"><span style="color: #BFBDB6">    (</span><span style="color: #FF8F40">SELECT</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">MAX</span><span style="color: #BFBDB6">(created_at) </span><span style="color: #FF8F40">FROM</span><span style="color: #BFBDB6"> tags),</span></span>
<span class="line"><span style="color: #BFBDB6">    INTERVAL </span><span style="color: #AAD94C">&#39;1 day&#39;</span></span>
<span class="line"><span style="color: #BFBDB6">  )) </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> </span><span style="color: #FF8F40">date</span></span>
<span class="line"><span style="color: #BFBDB6">),</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- count number of tags/day</span></span>
<span class="line"><span style="color: #BFBDB6">grouped_tags </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> (</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">SELECT</span></span>
<span class="line"><span style="color: #BFBDB6">  created_at,</span></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #F07178">COUNT</span><span style="color: #BFBDB6">(</span><span style="color: #F29668">*</span><span style="color: #BFBDB6">) </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> daily_count</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">FROM</span></span>
<span class="line"><span style="color: #BFBDB6">    tags</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">GROUP BY</span></span>
<span class="line"><span style="color: #BFBDB6">    created_at</span></span>
<span class="line"><span style="color: #BFBDB6">),</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- join to the full range and fill in values</span></span>
<span class="line"><span style="color: #BFBDB6">joined_dates_counts </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> (</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">SELECT</span></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #95E6CB">dr</span><span style="color: #BFBDB6">.</span><span style="color: #95E6CB">date</span><span style="color: #BFBDB6">,</span></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #F07178">COALESCE</span><span style="color: #BFBDB6">(</span><span style="color: #95E6CB">gt</span><span style="color: #BFBDB6">.</span><span style="color: #95E6CB">daily_count</span><span style="color: #BFBDB6">, </span><span style="color: #D2A6FF">0</span><span style="color: #BFBDB6">) </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> filled_daily_count</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">FROM</span></span>
<span class="line"><span style="color: #BFBDB6">    date_range dr</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">LEFT JOIN</span></span>
<span class="line"><span style="color: #BFBDB6">    grouped_tags gt</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">ON</span></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #95E6CB">dr</span><span style="color: #BFBDB6">.</span><span style="color: #95E6CB">date</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #95E6CB">gt</span><span style="color: #BFBDB6">.</span><span style="color: #95E6CB">created_at</span></span>
<span class="line"><span style="color: #BFBDB6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">-- get the cumulative sum and days since the min created_at</span></span>
<span class="line"><span style="color: #FF8F40">SELECT</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">date</span><span style="color: #BFBDB6">,</span></span>
<span class="line"><span style="color: #BFBDB6">  filled_daily_count,</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #F07178">SUM</span><span style="color: #BFBDB6">(filled_daily_count) </span><span style="color: #FF8F40">OVER</span><span style="color: #BFBDB6"> (</span><span style="color: #FF8F40">ORDER BY</span><span style="color: #BFBDB6"> </span><span style="color: #FF8F40">date</span><span style="color: #BFBDB6">) </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> running_cumulative_sum,</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #F07178">DATEDIFF</span><span style="color: #BFBDB6">(</span><span style="color: #AAD94C">&#39;day&#39;</span><span style="color: #BFBDB6">, (</span><span style="color: #FF8F40">SELECT</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">MIN</span><span style="color: #BFBDB6">(</span><span style="color: #FF8F40">date</span><span style="color: #BFBDB6">) </span><span style="color: #FF8F40">FROM</span><span style="color: #BFBDB6"> joined_dates_counts), </span><span style="color: #FF8F40">date</span><span style="color: #BFBDB6">) </span><span style="color: #FF8F40">AS</span><span style="color: #BFBDB6"> days_elapsed</span></span>
<span class="line"><span style="color: #FF8F40">FROM</span></span>
<span class="line"><span style="color: #BFBDB6">  joined_dates_counts;</span></span>
<span class="line"></span></code></pre>
<p><data-frame-view label="Tag Stats" id="tags-stats-view"></data-frame-view></p>
<pre class="shiki " style="background-color: #0b0e14" tabindex="0"><code><span class="line"><span style="color: #FF8F40">function</span><span style="color: #BFBDB6">(csum</span><span style="color: #BFBDB6B3">,</span><span style="color: #BFBDB6"> days_elapsed</span><span style="color: #BFBDB6B3">,</span><span style="color: #BFBDB6"> target_csum) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #ACB6BF8C; font-style: italic"># saddest. model. ever.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  model </span><span style="color: #F29668">&lt;-</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">glm</span><span style="color: #BFBDB6">(csum </span><span style="color: #FF8F40">~</span><span style="color: #BFBDB6"> days_elapsed, </span><span style="color: #D2A6FF">family</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #AAD94C">&quot;poisson&quot;</span><span style="color: #BFBDB6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  predicted_days_elapsed </span><span style="color: #F29668">&lt;-</span><span style="color: #BFBDB6"> days_elapsed</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">while</span><span style="color: #BFBDB6"> (</span><span style="color: #D2A6FF">TRUE</span><span style="color: #BFBDB6">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">    predicted_days_elapsed </span><span style="color: #F29668">&lt;-</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">max</span><span style="color: #BFBDB6">(predicted_days_elapsed) </span><span style="color: #F29668">+</span><span style="color: #BFBDB6"> </span><span style="color: #D2A6FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #F07178">predict</span><span style="color: #BFBDB6">(</span></span>
<span class="line"><span style="color: #BFBDB6">      model, </span></span>
<span class="line"><span style="color: #BFBDB6">      </span><span style="color: #D2A6FF">newdata</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #F07178">data.frame</span><span style="color: #BFBDB6">(</span><span style="color: #D2A6FF">days_elapsed</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> predicted_days_elapsed), </span></span>
<span class="line"><span style="color: #BFBDB6">      </span><span style="color: #D2A6FF">type</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #AAD94C">&quot;response&quot;</span></span>
<span class="line"><span style="color: #BFBDB6">    ) </span><span style="color: #F29668">-&gt;</span><span style="color: #BFBDB6"> predicted_csum</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">    </span><span style="color: #FF8F40">if</span><span style="color: #BFBDB6"> (predicted_csum </span><span style="color: #F29668">&gt;=</span><span style="color: #BFBDB6"> target_csum) </span><span style="color: #FF8F40">break</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">  predicted_days_elapsed</span></span>
<span class="line"></span>
<span class="line"><span style="color: #BFBDB6">}</span></span>
<span class="line"></span></code></pre>
<pre class="shiki " style="background-color: #0b0e14" tabindex="0"><code><span class="line"><span style="color: #ACB6BF8C; font-style: italic">// call the function</span></span>
<span class="line"><span style="color: #FF8F40">const</span><span style="color: #BFBDB6"> nDays </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #FF8F40">await</span><span style="color: #BFBDB6"> </span><span style="color: #FFB454">predict</span><span style="color: #BFBDB6">(</span></span>
<span class="line"><span style="color: #BFBDB6">  tagsCumSum</span><span style="color: #F29668">.</span><span style="color: #FFB454">map</span><span style="color: #BFBDB6">(</span><span style="color: #D2A6FF">d</span><span style="color: #BFBDB6"> </span><span style="color: #FF8F40">=&gt;</span><span style="color: #BFBDB6"> d</span><span style="color: #F29668">.</span><span style="color: #BFBDB6">csum)</span><span style="color: #BFBDB6B3">,</span></span>
<span class="line"><span style="color: #BFBDB6">  tagsCumSum</span><span style="color: #F29668">.</span><span style="color: #FFB454">map</span><span style="color: #BFBDB6">(</span><span style="color: #D2A6FF">d</span><span style="color: #BFBDB6"> </span><span style="color: #FF8F40">=&gt;</span><span style="color: #BFBDB6"> d</span><span style="color: #F29668">.</span><span style="color: #BFBDB6">days_elapsed)</span><span style="color: #BFBDB6B3">,</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #D2A6FF">1000</span></span>
<span class="line"><span style="color: #BFBDB6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ACB6BF8C; font-style: italic">// I hate date stuff in JS so much</span></span>
<span class="line"><span style="color: #FF8F40">function</span><span style="color: #BFBDB6"> </span><span style="color: #FFB454">addDays</span><span style="color: #BFBDB6">(</span><span style="color: #D2A6FF">date</span><span style="color: #BFBDB6B3">,</span><span style="color: #BFBDB6"> </span><span style="color: #D2A6FF">days</span><span style="color: #BFBDB6">) {</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">const</span><span style="color: #BFBDB6"> copy </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #F29668">new</span><span style="color: #BFBDB6"> </span><span style="color: #FFB454">Date</span><span style="color: #BFBDB6">(</span><span style="color: #FFB454">Number</span><span style="color: #BFBDB6">(date))</span></span>
<span class="line"><span style="color: #BFBDB6">  copy</span><span style="color: #F29668">.</span><span style="color: #FFB454">setDate</span><span style="color: #BFBDB6">(date</span><span style="color: #F29668">.</span><span style="color: #FFB454">getDate</span><span style="color: #BFBDB6">() </span><span style="color: #F29668">+</span><span style="color: #BFBDB6"> days)</span></span>
<span class="line"><span style="color: #BFBDB6">  </span><span style="color: #FF8F40">return</span><span style="color: #BFBDB6"> copy</span></span>
<span class="line"><span style="color: #BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF8F40">const</span><span style="color: #BFBDB6"> minDate </span><span style="color: #F29668">=</span><span style="color: #BFBDB6"> </span><span style="color: #FFB454">ddbResToArray</span><span style="color: #BFBDB6">(</span><span style="color: #FF8F40">await</span><span style="color: #BFBDB6"> </span><span style="color: #BFBDB6">db</span><span style="color: #F29668">.</span><span style="color: #FFB454">sql</span><span style="color: #AAD94C">`SELECT min(created_at) AS min_date FROM tags`</span><span style="color: #BFBDB6">)[</span><span style="color: #D2A6FF">0</span><span style="color: #BFBDB6">]</span><span style="color: #F29668">.</span><span style="color: #BFBDB6">min_date</span></span>
<span class="line"></span></code></pre>
<pre class="shiki " style="background-color: #0b0e14" tabindex="0"><code><span class="line"><span style="color: #FFB454">addDays</span><span style="color: #BFBDB6">(minDate</span><span style="color: #BFBDB6B3">,</span><span style="color: #BFBDB6"> nDays</span><span style="color: #F29668">.</span><span style="color: #BFBDB6">values[</span><span style="color: #D2A6FF">0</span><span style="color: #BFBDB6">])</span><span style="color: #F29668">.</span><span style="color: #FFB454">toDateString</span><span style="color: #BFBDB6">()</span></span>
<span class="line"></span></code></pre>
<p>We will reach 1,000 tags on or about <span id="predicted-date"></span>.</p>
<h2>FIN</h2>
<p>You can find the source <a href="https://github.com/hrbrmstr/webr-vite-duckdb">on GitHub</a>.</p>
<p style="text-align: center">Brought to you by @hrbrmstr</p>
<!-- extra body bits -->
</body>
</html>

